<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employee Map - Fair Oaks</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .employee-box {
      transition: all 0.2s ease-in-out;
      transform: scale(1);
      height: 72px;
    }
    
    @media (min-width: 768px) {
      .employee-box {
        height: 80px;
      }
    }
    
    .employee-box:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Center text in department buttons */
    .dept-btn.filter-dropdown,
    .dept-btn.filter-active {
      justify-content: center !important;
    }
    
    /* Notes sidebar styles */
    #notes-sidebar {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      height: 100vh;
      z-index: 1000;
      overflow-y: auto;
      transition: right 0.3s ease-in-out;
      background: var(--color-parchment);
      border-left: 1px solid #e5e7eb;
    }
    
    /* Desktop: fixed width sidebar */
    @media (min-width: 768px) {
      #notes-sidebar {
        right: -320px;
        width: 320px;
      }
    }
    
    .sidebar-open #notes-sidebar {
      right: 0;
    }
    
    /* Push main content when sidebar is open */
    .sidebar-open {
      overflow-x: hidden;
    }
    
    /* Shift the entire page content when sidebar opens */
    .sidebar-open #page-content-wrapper {
      margin-right: 100%;
      transition: margin-right 0.3s ease-in-out;
    }
    
    /* Desktop: use fixed margin */
    @media (min-width: 768px) {
      .sidebar-open #page-content-wrapper {
        margin-right: 320px;
      }
    }
    
    .note-item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .note-item .note-date {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    
    .note-item .note-text {
      font-size: 13px;
      line-height: 1.4;
      color: var(--color-espresso);
    }
    
    .note-item .delete-note {
      float: right;
      background: none;
      border: none;
      color: #dc2626;
      cursor: default;
      font-size: 18px;
      font-weight: bold;
      padding: 0;
      min-width: auto;
      min-height: auto;
      display: inline;
      align-items: center;
      justify-content: center;
      transition: none;
      margin-left: 8px;
      line-height: 1;
      opacity: 0.8;
      pointer-events: none;
    }
    
    .note-item .delete-note:hover {
      background: none;
      transform: none;
      box-shadow: none;
      color: #dc2626;
    }
    
    .note-item .delete-note:active {
      transform: none;
    }
    
    /* Mobile optimizations */
    @media (max-width: 767px) {
      #notes-sidebar {
        padding: 1rem;
      }
      
      .note-item {
        padding: 16px;
        margin-bottom: 12px;
      }
      
      .note-item .delete-note {
        font-size: 16px;
        padding: 8px;
        min-width: 44px;
        min-height: 44px;
      }
      
      #note-input {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 12px;
      }
      
      #add-note {
        padding: 12px 16px;
        font-size: 16px;
        min-height: 44px;
      }
    }
    
    /* Tablet optimizations (iPad, etc.) */
    @media (min-width: 768px) and (max-width: 1024px) {
      #notes-sidebar {
        width: 280px;
        padding: 1.5rem;
      }
      
      .sidebar-open #page-content-wrapper {
        margin-right: 280px;
      }
      
      .note-item {
        padding: 14px;
        margin-bottom: 10px;
      }
      
      .note-item .delete-note {
        font-size: 14px;
        padding: 6px;
        min-width: 36px;
        min-height: 36px;
      }
      
      #note-input {
        font-size: 14px;
        padding: 10px;
      }
      
      #add-note {
        padding: 10px 14px;
        font-size: 14px;
        min-height: 40px;
      }
      
      /* Ensure the Notes button is easily tappable on tablets */
      #notes-toggle {
        padding: 10px 16px;
        font-size: 14px;
        min-height: 44px;
      }
    }
  </style>
  <script>
    if (localStorage.getItem('mawney_logged_in') !== 'true') {
      window.location.href = 'login.html';
    }
  </script>
</head>
<body style="background: var(--color-alabaster);" class="min-h-screen flex flex-col">
  <!-- Page content wrapper -->
  <div id="page-content-wrapper" class="transition-all duration-300 ease-in-out">
    <!-- Header -->
    <header style="background: var(--color-alabaster); border-bottom: 1px solid #e0ddd7;" class="w-full">
      <div class="max-w-7xl mx-auto flex items-center justify-between py-4 px-4">
        <div class="flex items-center gap-4 md:gap-8">
          <a href="index.html"><img src="images/MP Logo Espresso.png" alt="Mawney Partners Logo" style="height: 40px; object-fit: contain;" class="block" /></a>
        </div>
        <nav class="flex items-center gap-4 md:gap-8">
          <a href="index.html#clients" style="color: var(--color-mawney-green);" class="text-sm md:text-base font-medium hover:underline hidden sm:block">Funds</a>
          <div class="relative">
            <input type="text" placeholder="Search..." class="rounded-full border border-[#b6b1a9] bg-transparent px-3 md:px-4 py-1 text-xs md:text-sm focus:outline-none focus:ring-2" style="min-width: 120px; max-width: 160px; color: var(--color-espresso);">
            <svg class="absolute right-2 md:right-3 top-1/2 -translate-y-1/2 w-3 h-3 md:w-4 md:h-4" style="color: var(--color-mawney-green);" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          </div>
          <button style="color: var(--color-mawney-green); border-color: #b6b1a9;" class="text-xs md:text-sm border rounded px-2 md:px-3 py-1 hover:bg-[#e0ddd7]">Edit mode</button>
          <button id="logout-btn" style="color: var(--color-mawney-green); border-color: #b6b1a9;" class="text-xs md:text-sm border rounded px-2 md:px-3 py-1 hover:bg-[#e0ddd7] ml-2">Log out</button>
        </nav>
      </div>
    </header>

    <!-- Hero Section -->
    <section style="background: var(--color-mawney-green);" class="w-full py-12 md:py-16">
      <div class="max-w-5xl mx-auto px-4 flex items-center justify-center">
        <img src="images/fair oaks white.png" alt="Fair Oaks" style="max-height: 48px; max-width: 100%; object-fit: contain; margin: 0 auto; display: block;" class="md:max-h-64" />
      </div>
    </section>

    <!-- Description -->
    <section class="w-full max-w-4xl mx-auto mt-8 md:mt-10 text-center px-4">
      <p class="mb-4 text-sm md:text-base leading-relaxed" style="color: var(--color-mawney-green);">
        Fair Oaks Capital is a European specialist corporate credit investment manager and advisor, launched in 2013, with offices in both London and New York. The firm's core expertise is in CLOs (Collateralised Loan Obligations) and secured loans. Current AUM of the Firm stands at $3.0 billion. Successfully launched its fifth European CLO in mid‑2025 with an ESG-compliant framework and strong early investor interest. A lean team of approximately 22 professionals, with 13 experienced investment staff.
      </p>
      
      <!-- Filter Tags -->
      <div class="flex flex-wrap justify-center gap-2 md:gap-3 mt-6 md:mt-8">
        <span class="px-3 py-1 rounded-full text-xs md:text-sm font-medium" style="background: var(--color-mawney-green); color: var(--color-parchment);">Liquid Credit</span>
        <span class="px-3 py-1 rounded-full text-xs md:text-sm font-medium" style="background: var(--color-mawney-green); color: var(--color-parchment);">Structured Finance</span>
        <span class="px-3 py-1 rounded-full text-xs md:text-sm font-medium" style="background: var(--color-mawney-green); color: var(--color-parchment);">London</span>
        <span class="px-3 py-1 rounded-full text-xs md:text-sm font-medium" style="background: var(--color-mawney-green); color: var(--color-parchment);">New York</span>
        <span class="px-3 py-1 rounded-full text-xs md:text-sm font-medium" style="background: var(--color-mawney-green); color: var(--color-parchment);">$3-10bn</span>
      </div>
    </section>

    <!-- Employees Section -->
    <section class="w-full mx-auto mt-6 md:mt-8 mb-12 md:mb-16 px-4" style="max-width: 100vw;">
      <div class="flex flex-col items-center mb-6 md:mb-8">
        <h2 class="text-xl md:text-2xl font-serif font-semibold mb-4" style="color: var(--color-mawney-green);">Employees</h2>
        <div class="flex flex-col sm:flex-row items-center gap-2 mb-4">
          <span class="text-xs md:text-sm mr-2">Navigate to department:</span>
          <div class="flex flex-wrap justify-center gap-2">
            <button class="dept-btn filter-active px-3 md:px-4 py-2 rounded text-xs md:text-sm text-center" data-department="business">Business</button>
            <button class="dept-btn filter-dropdown px-3 md:px-4 py-2 rounded text-xs md:text-sm text-center" data-department="investment">Investment</button>
            <button class="dept-btn filter-dropdown px-3 md:px-4 py-2 rounded text-xs md:text-sm text-center" data-department="trading">Trading</button>
            <button class="dept-btn filter-dropdown px-3 md:px-4 py-2 rounded text-xs md:text-sm text-center" data-department="capital-formation">Capital Formation</button>
            <button class="dept-btn filter-dropdown px-3 md:px-4 py-2 rounded text-xs md:text-sm text-center" data-department="c-suite">C-Suite</button>
          </div>
        </div>
      </div>
      <div class="flex justify-between items-center mb-4">
        <div>
          <button id="notes-toggle" class="px-3 md:px-4 py-2 rounded text-xs md:text-sm border flex items-center gap-2" style="border-color: var(--color-mawney-green); color: var(--color-mawney-green); background: var(--color-parchment);">
            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="md:w-4 md:h-4">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14,2 14,8 20,8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            <span class="font-bold">Notes</span>
          </button>
        </div>
        <div class="relative">
          <button id="filter-toggle" class="px-3 md:px-4 py-2 rounded text-xs md:text-sm border flex items-center gap-2" style="border-color: var(--color-mawney-green); color: var(--color-mawney-green); background: var(--color-parchment);">
          Filter Specialisms
          <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="md:w-4 md:h-4"><path d="M19 9l-7 7-7-7"/></svg>
        </button>
          <div id="filter-dropdown" class="absolute right-0 top-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg p-3 md:p-4 z-50 hidden" style="min-width: 280px; max-width: 90vw;">
            <div class="mb-3">
              <label class="text-xs md:text-sm font-semibold" style="color: var(--color-mawney-green);">Select Specialisms:</label>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-60 overflow-y-auto">
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Accounting" class="specialism-filter">
                <span>Accounting</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Asset Allocation" class="specialism-filter">
                <span>Asset Allocation</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Business Development" class="specialism-filter">
                <span>Business Development</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Capital Solutions" class="specialism-filter">
                <span>Capital Solutions</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Client Communications" class="specialism-filter">
                <span>Client Communications</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Client Relations" class="specialism-filter">
                <span>Client Relations</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Compliance" class="specialism-filter">
                <span>Compliance</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Corporate Strategy" class="specialism-filter">
                <span>Corporate Strategy</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Credit Analysis" class="specialism-filter">
                <span>Credit Analysis</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Credit Research" class="specialism-filter">
                <span>Credit Research</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Data Modeling" class="specialism-filter">
                <span>Data Modeling</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Distressed Credit" class="specialism-filter">
                <span>Distressed Credit</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Financial Analysis" class="specialism-filter">
                <span>Financial Analysis</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Financial Management" class="specialism-filter">
                <span>Financial Management</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Fund Reporting" class="specialism-filter">
                <span>Fund Reporting</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Insurance Asset Management" class="specialism-filter">
                <span>Insurance Asset Management</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Investment Management" class="specialism-filter">
                <span>Investment Management</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Investment Strategy" class="specialism-filter">
                <span>Investment Strategy</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Investor Relations" class="specialism-filter">
                <span>Investor Relations</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Leadership" class="specialism-filter">
                <span>Leadership</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Market Expansion" class="specialism-filter">
                <span>Market Expansion</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Market Research" class="specialism-filter">
                <span>Market Research</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Operations Management" class="specialism-filter">
                <span>Operations Management</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Portfolio Management" class="specialism-filter">
                <span>Portfolio Management</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Portfolio Operations" class="specialism-filter">
                <span>Portfolio Operations</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Regulatory Affairs" class="specialism-filter">
                <span>Regulatory Affairs</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Research" class="specialism-filter">
                <span>Research</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Risk Management" class="specialism-filter">
                <span>Risk Management</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Sales Strategy" class="specialism-filter">
                <span>Sales Strategy</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Special Situations" class="specialism-filter">
                <span>Special Situations</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Stakeholder Management" class="specialism-filter">
                <span>Stakeholder Management</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Strategic Planning" class="specialism-filter">
                <span>Strategic Planning</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Trading" class="specialism-filter">
                <span>Trading</span>
              </label>
              <label class="flex items-center gap-2 text-xs md:text-sm">
                <input type="checkbox" value="Treasury" class="specialism-filter">
                <span>Treasury</span>
              </label>
            </div>
            <div class="flex gap-2 mt-3 pt-3 border-t border-gray-200">
              <button id="clear-filters" class="px-3 py-1 text-xs md:text-sm border rounded" style="border-color: var(--color-mawney-green); color: var(--color-mawney-green);">Clear All</button>
              <button id="apply-filters" class="px-3 py-1 text-xs md:text-sm bg-[var(--color-mawney-green)] text-[var(--color-parchment)] rounded">Apply</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Main content and sidebar container -->
      <div class="flex gap-6 transition-all duration-300 ease-in-out" id="main-sidebar-container">
        <!-- Main content wrapper -->
        <div class="flex-1 transition-all duration-300 ease-in-out" id="main-content-wrapper">
          <!-- Main content area -->
          <div class="flex-1 transition-all duration-300 ease-in-out" id="main-content">
            <div class="border border-gray-400 rounded p-6 w-full overflow-x-auto relative pr-4" style="max-width: 100vw; background: var(--color-parchment);">
              <div id="department-grids-container">
                <!-- Dynamic department grids will be inserted here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer style="background: var(--color-mawney-green); color: var(--color-parchment);" class="mt-12 py-8">
      <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between px-4">
        <div class="text-sm mb-4 md:mb-0">
          37 Tanner Street<br>
          London SE1 3LF<br>
          <a href="mailto:info@mawneypartners.com" style="color: var(--color-parchment); text-decoration: underline;">info@mawneypartners.com</a><br>
          © Mawney Partners 2023 - Privacy Policy
        </div>
        <img src="images/long logo white.png" alt="Mawney Partners Long Logo" style="height: 36px; object-fit: contain;" class="block" />
      </div>
    </footer>
  </div>
  
  <!-- Notes Sidebar -->
  <div id="notes-sidebar" class="p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold" style="color: var(--color-mawney-green);">Notes</h3>
      <button id="close-notes" class="text-gray-500 hover:text-gray-700">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2" style="color: var(--color-mawney-green);">Add Note</label>
        <textarea id="note-input" rows="4" class="w-full p-3 border border-gray-300 rounded text-sm resize-none" placeholder="Enter your notes here..." style="background: white; color: var(--color-espresso);"></textarea>
        <button id="add-note" class="mt-2 px-4 py-2 bg-[var(--color-mawney-green)] text-[var(--color-parchment)] rounded text-sm hover:opacity-90">Add Note</button>
      </div>
      <div>
        <h4 class="text-sm font-medium mb-2" style="color: var(--color-mawney-green);">Recent Notes</h4>
        <div id="notes-list" class="space-y-2">
          <!-- Notes will be dynamically added here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Employee data with departments
      const employees = [
        {
          name: "Tyler Wallace",
          shortName: "Tyler<br>Wallace",
          title: "MD, PM",
          profile: "profile-tyler-wallace.html",
          departments: ["business", "investment", "c-suite"],
          specialisms: "Portfolio Management,Investment Management,CLOs,Secured Loans"
        },
        {
          name: "Abdulkadir Nasir",
          shortName: "Abdulkadir<br>Nasir",
          title: "VP, Credit Research Analyst",
          profile: "profile-abdulkadir-nasir.html",
          departments: ["business", "investment"],
          specialisms: "Credit Research,Credit Analysis,CLOs,European Markets"
        },
        {
          name: "Matilda Makitalo",
          shortName: "Matilda<br>Makitalo",
          title: "LevFin Credit Analyst",
          profile: "profile-matilda-makitalo.html",
          departments: ["business", "investment"],
          specialisms: "LevFin,Credit Analysis,European Markets,CLOs"
        },
        {
          name: "Alex Liu",
          shortName: "Alex<br>Liu",
          title: "VP",
          profile: "profile-alex-liu.html",
          departments: ["business", "investment"],
          specialisms: "Investment Management,Portfolio Management,CLOs,Secured Loans"
        },
        {
          name: "Rémi Nedelec",
          shortName: "Rémi<br>Nedelec",
          title: "VP",
          profile: "profile-remi-nedelec.html",
          departments: ["business", "investment"],
          specialisms: "Investment Management,Portfolio Management,CLOs,European Markets"
        },
        {
          name: "Philip Ryan",
          shortName: "Philip<br>Ryan",
          title: "VP, Credit Analyst",
          profile: "profile-philip-ryan.html",
          departments: ["business", "investment"],
          specialisms: "Credit Analysis,Credit Research,CLOs,Secured Loans"
        },
        {
          name: "Luke Streeter",
          shortName: "Luke<br>Streeter",
          title: "Associate",
          profile: "profile-luke-streeter.html",
          departments: ["business", "investment"],
          specialisms: "Credit Analysis,Investment Research,CLOs,Portfolio Management"
        },
        {
          name: "Roger Coyle",
          shortName: "Roger<br>Coyle",
          title: "Partner",
          profile: "profile-roger-coyle.html",
          departments: ["business", "investment", "c-suite"],
          specialisms: "Investment Management,Corporate Strategy,CLOs,Leadership"
        },
        {
          name: "Miguel Ramos Fuentenebro",
          shortName: "Miguel Ramos<br>Fuentenebro",
          title: "Partner",
          profile: "profile-miguel-ramos-fuentenebro.html",
          departments: ["business", "investment", "c-suite"],
          specialisms: "Investment Management,Corporate Strategy,CLOs,Leadership"
        },
        {
          name: "William Sheoris",
          shortName: "William<br>Sheoris",
          title: "Partner",
          profile: "profile-william-sheoris.html",
          departments: ["business", "investment", "c-suite"],
          specialisms: "Investment Management,Corporate Strategy,CLOs,Leadership"
        },
        {
          name: "Firas Joumblat",
          shortName: "Firas<br>Joumblat",
          title: "Investment Analyst",
          profile: "#",
          departments: ["business", "investment"],
          specialisms: "Investment Analysis,Credit Research,CLOs,European Markets"
        },
        {
          name: "Bradley Pearman",
          shortName: "Bradley<br>Pearman",
          title: "Associate",
          profile: "#",
          departments: ["business", "investment"],
          specialisms: "Investment Management,Portfolio Management,CLOs,Secured Loans"
        },
        {
          name: "David Spence",
          shortName: "David<br>Spence",
          title: "Business Development",
          profile: "#",
          departments: ["business", "capital-formation"],
          specialisms: "Business Development,Client Relations,Fund Raising,Strategic Planning"
        },
        {
          name: "Barry Povey",
          shortName: "Barry<br>Povey",
          title: "Principal, PM",
          profile: "#",
          departments: ["business", "investment", "c-suite"],
          specialisms: "Portfolio Management,Investment Management,CLOs,Leadership"
        },
        {
          name: "Archie Hancock",
          shortName: "Archie<br>Hancock",
          title: "Investor Relations Analyst",
          profile: "#",
          departments: ["business", "capital-formation"],
          specialisms: "Investor Relations,Client Relations,Fund Raising,Stakeholder Management"
        },
        {
          name: "Alfonso Aceves",
          shortName: "Alfonso<br>Aceves",
          title: "CLO Investment Associate",
          profile: "#",
          departments: ["business", "investment"],
          specialisms: "CLOs,Investment Management,Structured Products,Portfolio Management"
        },
        {
          name: "Aisha Fowosire",
          shortName: "Aisha<br>Fowosire",
          title: "Operations",
          profile: "#",
          departments: ["business"],
          specialisms: "Operations Management,Process Improvement,Compliance,Risk Management"
        },
        {
          name: "Ilze Petersone",
          shortName: "Ilze<br>Petersone",
          title: "Compliance Manager",
          profile: "#",
          departments: ["business"],
          specialisms: "Compliance,Risk Management,Regulatory Affairs,Operations"
        },
        {
          name: "Prakash P.",
          shortName: "Prakash<br>P.",
          title: "Head of Finance and Operations",
          profile: "#",
          departments: ["business", "c-suite"],
          specialisms: "Finance,Operations Management,Strategic Planning,Leadership"
        },
        {
          name: "Charles C.",
          shortName: "Charles<br>C.",
          title: "General Counsel",
          profile: "#",
          departments: ["business", "c-suite"],
          specialisms: "Legal,Compliance,Risk Management,Corporate Governance"
        },
        {
          name: "Morten Simonsen",
          shortName: "Morten<br>Simonsen",
          title: "Business Development / Fund Raising",
          profile: "#",
          departments: ["business", "capital-formation"],
          specialisms: "Business Development,Fund Raising,Client Relations,Strategic Planning"
        },
        {
          name: "Jason S.",
          shortName: "Jason<br>S.",
          title: "CLO Structured Products",
          profile: "#",
          departments: ["business", "investment"],
          specialisms: "CLOs,Structured Products,Investment Management,Portfolio Management"
        },
        {
          name: "Miguel Arraya",
          shortName: "Miguel<br>Arraya",
          title: "Non Executive Director",
          profile: "#",
          departments: ["business", "c-suite"],
          specialisms: "Corporate Governance,Strategic Planning,Leadership,Board Management"
        }
      ];

      // Department configurations
      const departments = {
        "business": { name: "Business", color: "#0b4c3a" },
        "investment": { name: "Investment", color: "#0b4c3a" },
        "trading": { name: "Trading", color: "#0b4c3a" },
        "capital-formation": { name: "Capital Formation", color: "#0b4c3a" },
        "c-suite": { name: "C-Suite", color: "#0b4c3a" }
      };

      let selectedDepartments = ['business'];
      let zoomLevels = {};

      // Initialize zoom levels for all departments
      Object.keys(departments).forEach(dept => {
        zoomLevels[dept] = 1;
      });
      
      // Initialize zoom levels for Business sub-grids
      zoomLevels["business1"] = 1;
      zoomLevels["business2"] = 1;
      zoomLevels["business3"] = 1;

      // Department button functionality
      const deptButtons = document.querySelectorAll('.dept-btn');
      deptButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const dept = this.getAttribute('data-department');
          // Deselect all buttons
          deptButtons.forEach(b => {
            b.classList.remove('filter-active');
            b.classList.add('filter-dropdown');
          });
          // Select only the clicked button
          this.classList.remove('filter-dropdown');
          this.classList.add('filter-active');
          // Set selectedDepartments to only the clicked department
          selectedDepartments = [dept];
          renderDepartmentGrids();
        });
      });

      // Render department grids
      function renderDepartmentGrids() {
        const container = document.getElementById('department-grids-container');
        container.innerHTML = '';
        
        if (selectedDepartments.length === 1 && selectedDepartments[0] === 'business') {
          // Business view: two grids side by side
          // Grid 1 (London)
          const grid1Hierarchy = [
            ["Roger Coyle", "Miguel Ramos Fuentenebro", "Barry Povey"],
            ["Tyler Wallace", "Abdulkadir Nasir", "Alex Liu", "David Spence"],
            ["Philip Ryan", "Luke Streeter", "Rémi Nedelec", "Matilda Makitalo", "Firas Joumblat", "Bradley Pearman"],
            ["Archie Hancock", "Aisha Fowosire", "Ilze Petersone", "Prakash P.", "Charles C."]
          ];
          // Grid 2 (New York)
          const grid2Hierarchy = [
            ["William Sheoris"],
            ["Alfonso Aceves", "Jason S."],
            []
          ];
          // Grid 3 (Europe)
          const grid3Hierarchy = [
            ["Morten Simonsen", "Miguel Arraya"],
            [],
            []
          ];
          const grid1Employees = employees.filter(emp => grid1Hierarchy.flat().includes(emp.name));
          const grid2Employees = employees.filter(emp => grid2Hierarchy.flat().includes(emp.name));
          const grid3Employees = employees.filter(emp => grid3Hierarchy.flat().includes(emp.name));
          
          // Container for three grids side by side
          const businessContainer = document.createElement('div');
          businessContainer.className = 'flex flex-col lg:flex-row gap-8 justify-between w-full';
          
          // Grid 1 (London)
          const gridDiv1 = document.createElement('div');
          gridDiv1.className = 'w-full lg:w-1/3 min-w-0 overflow-x-auto relative';
          gridDiv1.innerHTML = `
            <div class="w-full min-w-0 overflow-x-auto relative">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-serif font-semibold" style="color: var(--color-mawney-green);">London</h3>
                <div class="flex items-center gap-2">
                  <button class="zoom-out-btn px-2 py-1 border rounded text-sm" data-dept="business1" style="color: var(--color-mawney-green); border-color: var(--color-mawney-green);">–</button>
                  <span class="zoom-label text-xs text-gray-600" data-dept="business1">100%</span>
                  <button class="zoom-in-btn px-2 py-1 border rounded text-sm" data-dept="business1" style="color: var(--color-mawney-green); border-color: var(--color-mawney-green);">+</button>
                </div>
              </div>
              <div class="zoom-area" data-dept="business1" style="transition: transform 0.2s; transform: scale(1); transform-origin: left top;">
                <div class="flex flex-col items-start gap-4 w-[600px] max-w-full" style="padding: 8px;">
                  ${generateCustomEmployeeRows(grid1Hierarchy, grid1Employees)}
                </div>
              </div>
            </div>
          `;
          
          businessContainer.appendChild(gridDiv1);
          
          // Add dashed line divider between London and New York
          const divider1 = document.createElement('div');
          divider1.className = 'hidden lg:block w-px mx-4';
          divider1.style.borderLeft = '2px dashed var(--color-espresso)';
          divider1.style.height = '100%';
          divider1.style.minHeight = '400px';
          businessContainer.appendChild(divider1);
          
          // Grid 2 (New York)
          const gridDiv2 = document.createElement('div');
          gridDiv2.className = 'w-full lg:w-1/3 min-w-0 overflow-x-auto relative';
          gridDiv2.innerHTML = `
            <div class="w-full min-w-0 overflow-x-auto relative">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-serif font-semibold" style="color: var(--color-mawney-green);">New York</h3>
                <div class="flex items-center gap-2">
                  <button class="zoom-out-btn px-2 py-1 border rounded text-sm" data-dept="business2" style="color: var(--color-mawney-green); border-color: var(--color-mawney-green);">–</button>
                  <span class="zoom-label text-xs text-gray-600" data-dept="business2">100%</span>
                  <button class="zoom-in-btn px-2 py-1 border rounded text-sm" data-dept="business2" style="color: var(--color-mawney-green); border-color: var(--color-mawney-green);">+</button>
                </div>
              </div>
              <div class="zoom-area" data-dept="business2" style="transition: transform 0.2s; transform: scale(1); transform-origin: left top;">
                <div class="flex flex-col items-start gap-4 w-[600px] max-w-full" style="padding: 8px;">
                  ${generateCustomEmployeeRows(grid2Hierarchy, grid2Employees)}
                </div>
              </div>
            </div>
          `;
          
          businessContainer.appendChild(gridDiv2);
          
          // Add dashed line divider between New York and Europe
          const divider2 = document.createElement('div');
          divider2.className = 'hidden lg:block w-px mx-4';
          divider2.style.borderLeft = '2px dashed var(--color-espresso)';
          divider2.style.height = '100%';
          divider2.style.minHeight = '400px';
          businessContainer.appendChild(divider2);
          
          // Grid 3 (Europe)
          const gridDiv3 = document.createElement('div');
          gridDiv3.className = 'w-full lg:w-1/3 min-w-0 overflow-x-auto relative';
          gridDiv3.innerHTML = `
            <div class="w-full min-w-0 overflow-x-auto relative">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-serif font-semibold" style="color: var(--color-mawney-green);">Europe</h3>
                <div class="flex items-center gap-2">
                  <button class="zoom-out-btn px-2 py-1 border rounded text-sm" data-dept="business3" style="color: var(--color-mawney-green); border-color: var(--color-mawney-green);">–</button>
                  <span class="zoom-label text-xs text-gray-600" data-dept="business3">100%</span>
                  <button class="zoom-in-btn px-2 py-1 border rounded text-sm" data-dept="business3" style="color: var(--color-mawney-green); border-color: var(--color-mawney-green);">+</button>
                </div>
              </div>
              <div class="zoom-area" data-dept="business3" style="transition: transform 0.2s; transform: scale(1); transform-origin: left top;">
                <div class="flex flex-col items-start gap-4 w-[600px] max-w-full" style="padding: 8px;">
                  ${generateCustomEmployeeRows(grid3Hierarchy, grid3Employees)}
                </div>
              </div>
            </div>
          `;
          
          businessContainer.appendChild(gridDiv3);
          container.appendChild(businessContainer);
          
          // Attach zoom listeners for both grids
          attachZoomListeners();
          return;
        }
        
        // All other departments: single grid as before
        selectedDepartments.forEach((dept, index) => {
          const deptEmployees = employees.filter(emp => emp.departments.includes(dept));
          
          if (deptEmployees.length === 0) return;
          
          const gridDiv = document.createElement('div');
          gridDiv.className = 'w-full mb-8';
          if (index > 0) {
            gridDiv.className += ' mt-8 pt-8 border-t border-gray-300';
          }
          
          gridDiv.innerHTML = `
            <div class="w-full min-w-0 overflow-x-auto relative">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-xl font-serif font-semibold" style="color: var(--color-mawney-green);">${departments[dept].name}</h3>
                <div class="flex items-center gap-2">
                  <button class="zoom-out-btn px-2 py-1 border rounded text-sm" data-dept="${dept}" style="color: var(--color-mawney-green); border-color: var(--color-mawney-green);">–</button>
                  <span class="zoom-label text-xs text-gray-600" data-dept="${dept}">100%</span>
                  <button class="zoom-in-btn px-2 py-1 border rounded text-sm" data-dept="${dept}" style="color: var(--color-mawney-green); border-color: var(--color-mawney-green);">+</button>
                </div>
              </div>
              <div class="zoom-area" data-dept="${dept}" style="transition: transform 0.2s; transform: scale(1); transform-origin: left top;">
                <div class="flex flex-col items-start gap-4 w-[600px] max-w-full" style="padding: 8px;">
                  ${generateEmployeeRows(deptEmployees)}
                </div>
              </div>
            </div>
          `;
          
          container.appendChild(gridDiv);
        });
        
        // Re-attach zoom event listeners
        attachZoomListeners();

        // After rendering, update department button selected state
        const deptButtons = document.querySelectorAll('.dept-btn');
        deptButtons.forEach(btn => {
          if (selectedDepartments.includes(btn.getAttribute('data-department'))) {
            btn.classList.remove('filter-dropdown');
            btn.classList.add('filter-active');
          } else {
            btn.classList.remove('filter-active');
            btn.classList.add('filter-dropdown');
          }
        });
      }

      // Generate employee rows for a department
      function generateEmployeeRows(employees) {
        // Define the hierarchy structure
        const hierarchy = [
          ["Roger Coyle", "Miguel Ramos Fuentenebro", "William Sheoris"], // Row 1: Partners
          ["Tyler Wallace", "Abdulkadir Nasir", "Alex Liu", "Rémi Nedelec", "Philip Ryan"], // Row 2: VPs and MD
          ["Matilda Makitalo", "Luke Streeter"] // Row 3: Analysts and Associates
        ];
        
        const rows = [];
        
        hierarchy.forEach(rowEmployees => {
          const rowDivs = [];
          
          rowEmployees.forEach(empName => {
            const employee = employees.find(emp => emp.name === empName);
            if (employee) {
              rowDivs.push(`
                <a href="${employee.profile}" class="employee-box bg-[#0b4c3a] text-white rounded p-2 w-32 md:w-40 h-[72px] md:h-[80px] text-left flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-0 justify-between" style="text-decoration: none;" data-specialisms="${employee.specialisms}">
                  <div class="flex-1">
                    <div class="font-semibold text-xs md:text-sm leading-tight break-words">${employee.shortName}</div>
                    <div class="text-xs mt-1 break-words">${employee.title}</div>
                  </div>
                  <img src="images/profile.png" alt="Profile" class="hidden md:block w-8 h-8 md:w-10 md:h-10 rounded-full object-cover self-end md:self-center mt-2 md:mt-0" />
                </a>
              `);
            }
          });
          
          if (rowDivs.length > 0) {
            rows.push(`<div class="flex flex-row gap-2 md:gap-4">${rowDivs.join('')}</div>`);
          }
        });
        
        return rows.join('');
      }

      // Attach zoom event listeners
      function attachZoomListeners() {
        // Zoom in buttons
        document.querySelectorAll('.zoom-in-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const dept = this.getAttribute('data-dept');
            if (zoomLevels[dept] < 2) zoomLevels[dept] += 0.1;
            zoomLevels[dept] = Math.round(zoomLevels[dept] * 10) / 10;
            
            const zoomArea = document.querySelector(`[data-dept="${dept}"].zoom-area`);
            const zoomLabel = document.querySelector(`[data-dept="${dept}"].zoom-label`);
            
            zoomArea.style.transform = `scale(${zoomLevels[dept]})`;
            zoomLabel.textContent = Math.round(zoomLevels[dept] * 100) + '%';
          });
        });
        
        // Zoom out buttons
        document.querySelectorAll('.zoom-out-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const dept = this.getAttribute('data-dept');
            if (zoomLevels[dept] > 0.1) zoomLevels[dept] -= 0.1;
            zoomLevels[dept] = Math.round(zoomLevels[dept] * 10) / 10;
            
            const zoomArea = document.querySelector(`[data-dept="${dept}"].zoom-area`);
            const zoomLabel = document.querySelector(`[data-dept="${dept}"].zoom-label`);
            
            zoomArea.style.transform = `scale(${zoomLevels[dept]})`;
            zoomLabel.textContent = Math.round(zoomLevels[dept] * 100) + '%';
          });
        });
      }

      // Specialism Filter Functionality
      const filterToggle = document.getElementById('filter-toggle');
      const filterDropdown = document.getElementById('filter-dropdown');
      const clearAllBtn = document.getElementById('clear-filters');
      const applyFilterBtn = document.getElementById('apply-filters');
      const specialismFilters = document.querySelectorAll('.specialism-filter');

      // Toggle filter dropdown
      filterToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        filterDropdown.classList.toggle('hidden');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!filterDropdown.contains(e.target) && !filterToggle.contains(e.target)) {
          filterDropdown.classList.add('hidden');
        }
      });

      // Clear all specialisms
      if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function() {
          specialismFilters.forEach(checkbox => {
            checkbox.checked = false;
          });
        });
      }

      // Apply filter
      if (applyFilterBtn) {
        applyFilterBtn.addEventListener('click', function() {
          const selectedSpecialisms = Array.from(specialismFilters)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);

          const employeeBoxes = document.querySelectorAll('.employee-box');
          
          employeeBoxes.forEach(box => {
            const boxSpecialisms = box.getAttribute('data-specialisms');
            if (!boxSpecialisms) {
              box.style.display = 'none';
              return;
            }

            const boxSpecialismArray = boxSpecialisms.split(',').map(s => s.trim());
            
            // Show box if it has ANY of the selected specialisms, or if no specialisms are selected (show all)
            const shouldShow = selectedSpecialisms.length === 0 || 
                              selectedSpecialisms.some(specialism => boxSpecialismArray.includes(specialism));
            
            box.style.display = shouldShow ? 'flex' : 'none';
          });

          // Close dropdown after applying filter
          filterDropdown.classList.add('hidden');
        });
      }

      // Generate custom employee rows for a given hierarchy
      function generateCustomEmployeeRows(hierarchy, employees) {
        const rows = [];
        hierarchy.forEach(rowEmployees => {
          const rowDivs = [];
          rowEmployees.forEach(empName => {
            const employee = employees.find(emp => emp.name === empName);
            if (employee) {
              rowDivs.push(`
                <a href="${employee.profile}" class="employee-box bg-[#0b4c3a] text-white rounded p-2 w-32 md:w-40 h-[72px] md:h-[80px] text-left flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-0 justify-between" style="text-decoration: none;" data-specialisms="${employee.specialisms}">
                  <div class="flex-1">
                    <div class="font-semibold text-xs md:text-sm leading-tight break-words">${employee.shortName}</div>
                    <div class="text-xs mt-1 break-words">${employee.title}</div>
                  </div>
                  <img src="images/profile.png" alt="Profile" class="hidden md:block w-8 h-8 md:w-10 md:h-10 rounded-full object-cover self-end md:self-center mt-2 md:mt-0" />
                </a>
              `);
            }
          });
          if (rowDivs.length > 0) {
            rows.push(`<div class="flex flex-row gap-2 md:gap-4">${rowDivs.join('')}</div>`);
          }
        });
        return rows.join('');
      }

      // At the end of the script, add:
      selectedDepartments = ['business'];
      renderDepartmentGrids();

      // Logout logic
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.onclick = function() {
          localStorage.removeItem('mawney_logged_in');
          window.location.href = 'login.html';
        };
      }

      // Notes Sidebar Functionality
      const notesToggle = document.getElementById('notes-toggle');
      const closeNotes = document.getElementById('close-notes');
      const notesSidebar = document.getElementById('notes-sidebar');
      const mainSidebarContainer = document.getElementById('main-sidebar-container');
      const noteInput = document.getElementById('note-input');
      const addNoteBtn = document.getElementById('add-note');
      const notesList = document.getElementById('notes-list');

      // Debug: Check if elements are found
      console.log('Notes toggle element:', notesToggle);
      console.log('Notes sidebar element:', notesSidebar);
      console.log('Close notes element:', closeNotes);
      console.log('Note input element:', noteInput);
      console.log('Add note button element:', addNoteBtn);
      console.log('Notes list element:', notesList);

      // Additional debugging for the notes toggle button
      if (notesToggle) {
        console.log('Notes toggle button details:');
        console.log('- Element:', notesToggle);
        console.log('- Computed style:', window.getComputedStyle(notesToggle));
        console.log('- Offset dimensions:', notesToggle.offsetWidth, 'x', notesToggle.offsetHeight);
        console.log('- Position:', notesToggle.offsetLeft, notesToggle.offsetTop);
        console.log('- Visible:', notesToggle.offsetWidth > 0 && notesToggle.offsetHeight > 0);
      }

      // Only add event listeners if elements exist
      if (notesToggle) {
        console.log('Notes toggle button found, adding event listener');
        
        // Add a simple test to verify the button is working
        notesToggle.addEventListener('mouseover', function() {
          console.log('Mouse over notes button');
        });
        
        // Toggle sidebar
        notesToggle.addEventListener('click', function(e) {
          console.log('Notes button clicked!');
          console.log('Event:', e);
          console.log('Current body classes:', document.body.classList.toString());
          console.log('Notes sidebar element:', notesSidebar);
          
          if (document.body.classList.contains('sidebar-open')) {
            console.log('Closing sidebar');
            // Close sidebar
            document.body.classList.remove('sidebar-open');
            // Reset button to default styling
            this.style.borderColor = 'var(--color-mawney-green)';
            this.style.color = 'var(--color-mawney-green)';
            this.style.background = 'var(--color-parchment)';
          } else {
            console.log('Opening sidebar');
            // Open sidebar
            document.body.classList.add('sidebar-open');
            // Set button to active styling (green background)
            this.style.borderColor = 'var(--color-mawney-green)';
            this.style.color = 'var(--color-parchment)';
            this.style.background = 'var(--color-mawney-green)';
            // Always render notes when opening sidebar
            renderNotes();
          }
          
          console.log('After toggle - body classes:', document.body.classList.toString());
        });
      } else {
        console.error('Notes toggle button not found!');
      }

      if (closeNotes) {
        closeNotes.addEventListener('click', function() {
          document.body.classList.remove('sidebar-open');
          // Reset button to default styling
          if (notesToggle) {
            notesToggle.style.borderColor = 'var(--color-mawney-green)';
            notesToggle.style.color = 'var(--color-mawney-green)';
            notesToggle.style.background = 'var(--color-parchment)';
          }
        });
      }

      if (addNoteBtn && noteInput) {
        // Add note
        addNoteBtn.addEventListener('click', async function() {
          const noteText = noteInput.value.trim();
          if (noteText) {
            const newNote = await addNote(noteText);
            if (newNote) {
              noteInput.value = '';
              renderNotes();
            }
          }
        });

        // Enter key to add note
        noteInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addNoteBtn.click();
          }
        });
      }

      // Supabase configuration - REPLACE WITH YOUR ACTUAL VALUES
      // Go to your Supabase project → Settings → API to get these values
      const SUPABASE_URL = 'https://ihkmboslfmokgavjnmkc.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imloa21ib3NsZm1va2dhdmpubWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MzMxNzEsImV4cCI6MjA2NzIwOTE3MX0.hQQpgK8I9WCMpIWZv9dcQNB2lzo7MeYe-4bpFL99Fpk';
      
      // Initialize Supabase client only if configuration is provided
      let supabase = null;
      if (SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY_HERE') {
        try {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('Supabase client initialized successfully');
        } catch (error) {
          console.error('Error initializing Supabase client:', error);
        }
      } else {
        console.log('Supabase not configured - using local storage fallback');
      }

      // Load notes from Supabase or localStorage
      async function loadNotes() {
        console.log('loadNotes called');
        console.log('Supabase available:', !!supabase);
        
        if (supabase) {
          try {
            console.log('Loading from Supabase...');
            // Add cache-busting parameter to force fresh data
            const { data, error } = await supabase
              .from('fair_oaks_notes')
              .select('*')
              .order('created_at', { ascending: false })
              .abortSignal(new AbortController().signal); // Force fresh request
            
            if (error) {
              console.error('Supabase load error:', error);
              throw error;
            }
            
            console.log('Supabase returned data:', data);
            return data || [];
          } catch (error) {
            console.error('Error loading notes from Supabase:', error);
            console.log('Falling back to localStorage...');
            return loadNotesFromLocalStorage();
          }
        } else {
          console.log('Supabase not available, loading from localStorage...');
          return loadNotesFromLocalStorage();
        }
      }

      // Load notes from localStorage
      function loadNotesFromLocalStorage() {
        try {
          const notes = localStorage.getItem('fair-oaks-employee-map-notes');
          return notes ? JSON.parse(notes) : [];
        } catch (error) {
          console.error('Error loading notes from localStorage:', error);
          return [];
        }
      }

      // Add note via Supabase or localStorage
      async function addNote(noteText) {
        const newNote = {
          id: Date.now().toString(), // Ensure ID is a string
          text: noteText,
          created_at: new Date().toISOString()
        };

        if (supabase) {
          try {
            const { data, error } = await supabase
              .from('fair_oaks_notes')
              .insert([newNote])
              .select();
            
            if (error) throw error;
            return data[0];
          } catch (error) {
            console.error('Error adding note to Supabase:', error);
            return addNoteToLocalStorage(newNote);
          }
        } else {
          return addNoteToLocalStorage(newNote);
        }
      }

      // Add note to localStorage
      function addNoteToLocalStorage(note) {
        try {
          const notes = loadNotesFromLocalStorage();
          notes.unshift(note);
          localStorage.setItem('fair-oaks-employee-map-notes', JSON.stringify(notes));
          return note;
        } catch (error) {
          console.error('Error adding note to localStorage:', error);
          return null;
        }
      }

      // Render notes
      async function renderNotes() {
        console.log('renderNotes called');
        if (!notesList) {
          console.error('notesList element not found');
          return;
        }
        
        const notes = await loadNotes();
        console.log('Loaded notes for rendering:', notes);
        
        // Clear the list completely
        notesList.innerHTML = '';
        console.log('Cleared notesList innerHTML');
        
        if (notes.length === 0) {
          console.log('No notes to display');
          return;
        }
        
        notes.forEach((note, index) => {
          console.log(`Creating note element ${index}:`, note);
          const noteElement = document.createElement('div');
          noteElement.className = 'note-item';
          noteElement.setAttribute('data-note-id', note.id); // Add data attribute to the container
          const date = new Date(note.created_at).toLocaleString();
          noteElement.innerHTML = `
            <button class="delete-note" data-note-id="${note.id}" title="Delete note">×</button>
            <div class="note-date">${date}</div>
            <div class="note-text">${note.text.replace(/\n/g, '<br>')}</div>
          `;
          
          // Add direct event listener to the delete button
          const deleteBtn = noteElement.querySelector('.delete-note');
          if (deleteBtn) {
            // Remove click event listener - make button decorative only
            deleteBtn.style.pointerEvents = 'none';
            deleteBtn.style.opacity = '0.6';
          }
          
          notesList.appendChild(noteElement);
          console.log('Added note element with ID:', note.id);
        });
        console.log('Notes rendered, total elements:', notesList.children.length);
      }

      // Close sidebar when clicking outside
      document.addEventListener('click', function(e) {
        if (notesSidebar && notesToggle && !notesSidebar.contains(e.target) && !notesToggle.contains(e.target) && document.body.classList.contains('sidebar-open')) {
          document.body.classList.remove('sidebar-open');
        }
      });

      // Test function to help debug
      window.testNotes = function() {
        console.log('=== NOTES DEBUG INFO ===');
        console.log('notesList element:', notesList);
        console.log('notesSidebar element:', notesSidebar);
        console.log('notesToggle element:', notesToggle);
        console.log('Current notes in localStorage:', localStorage.getItem('employee-map-notes'));
        console.log('Sidebar open:', document.body.classList.contains('sidebar-open'));
        
        if (notesList) {
          console.log('Notes list children:', notesList.children.length);
          Array.from(notesList.children).forEach((child, index) => {
            const deleteBtn = child.querySelector('.delete-note');
            console.log(`Note ${index}:`, {
              element: child,
              deleteButton: deleteBtn,
              noteId: deleteBtn ? deleteBtn.getAttribute('data-note-id') : 'none'
            });
          });
        }
        console.log('=== END DEBUG INFO ===');
      };

      // Test function to manually trigger sidebar
      window.testSidebar = function() {
        console.log('=== TESTING SIDEBAR ===');
        console.log('Current body classes:', document.body.classList.toString());
        
        if (document.body.classList.contains('sidebar-open')) {
          console.log('Closing sidebar...');
          document.body.classList.remove('sidebar-open');
        } else {
          console.log('Opening sidebar...');
          document.body.classList.add('sidebar-open');
          renderNotes();
        }
        
        console.log('New body classes:', document.body.classList.toString());
        console.log('=== END SIDEBAR TEST ===');
      };

      // Test function to verify deletion
      window.testDeletion = async function() {
        console.log('=== TESTING DELETION ===');
        console.log('Delete functionality has been removed - × button is now decorative only');
        console.log('To delete notes, you can manually clear localStorage or use the nuclear option');
        console.log('=== END DELETION TEST ===');
      };

      // Test function to verify storage
      window.testStorage = async function() {
        console.log('=== TESTING STORAGE ===');
        console.log('Supabase configured:', !!supabase);
        console.log('localStorage available:', typeof localStorage !== 'undefined');
        
        const notes = await loadNotes();
        console.log('Current notes in storage:', notes);
        console.log('localStorage raw data:', localStorage.getItem('employee-map-notes'));
        
        if (supabase) {
          try {
            const { data, error } = await supabase
              .from('fair_oaks_notes')
              .select('*');
            if (error) {
              console.error('Supabase query error:', error);
            } else {
              console.log('Supabase notes:', data);
            }
          } catch (error) {
            console.error('Supabase connection error:', error);
          }
        }
        console.log('=== END STORAGE TEST ===');
      };

      // Function to clear cache and force fresh load
      window.clearNotesCache = function() {
        console.log('=== CLEARING NOTES CACHE ===');
        try {
          localStorage.removeItem('fair-oaks-employee-map-notes');
          console.log('✅ localStorage cleared');
        } catch (error) {
          console.error('❌ Error clearing localStorage:', error);
        }
        
        // Force browser cache refresh
        if (window.location.reload) {
          console.log('🔄 Reloading page to clear cache...');
          window.location.reload(true);
        }
        console.log('=== END CACHE CLEAR ===');
      };

      // Function to force refresh notes
      window.refreshNotes = async function() {
        console.log('=== FORCING NOTES REFRESH ===');
        if (notesList) {
          notesList.innerHTML = '';
          console.log('✅ Cleared notes list');
        }
        await renderNotes();
        console.log('=== END NOTES REFRESH ===');
      };

      // Function to clear Supabase cache and force fresh load
      window.clearSupabaseCache = async function() {
        console.log('=== CLEARING SUPABASE CACHE ===');
        if (supabase) {
          try {
            // Force a fresh query by using a new client instance
            const freshSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data, error } = await freshSupabase
              .from('fair_oaks_notes')
              .select('*')
              .order('created_at', { ascending: false });
            
            if (error) {
              console.error('Fresh Supabase query error:', error);
            } else {
              console.log('Fresh Supabase data:', data);
            }
          } catch (error) {
            console.error('Error clearing Supabase cache:', error);
          }
        }
        console.log('=== END SUPABASE CACHE CLEAR ===');
      };

      // Nuclear option: Clear all notes from both storage locations
      window.clearAllNotes = async function() {
        console.log('=== NUCLEAR OPTION: CLEARING ALL NOTES ===');
        
        if (supabase) {
          try {
            console.log('Deleting all notes from Supabase...');
            const { error } = await supabase
              .from('fair_oaks_notes')
              .delete()
              .neq('id', '0'); // Delete all notes (this will delete everything)
            
            if (error) {
              console.error('Supabase clear error:', error);
            } else {
              console.log('✅ All notes deleted from Supabase');
            }
          } catch (error) {
            console.error('Error clearing Supabase notes:', error);
          }
        }
        
        try {
          console.log('Clearing localStorage...');
          localStorage.removeItem('fair-oaks-employee-map-notes');
          console.log('✅ localStorage cleared');
        } catch (error) {
          console.error('Error clearing localStorage:', error);
        }
        
        console.log('=== END NUCLEAR CLEAR ===');
        // Force page refresh
        setTimeout(() => {
          window.location.reload(true);
        }, 1000);
      };

      // Simple localStorage test
      window.testLocalStorage = function() {
        console.log('=== TESTING LOCALSTORAGE ===');
        const testKey = 'test-notes-key';
        const testData = [{ id: 'test1', text: 'test note', created_at: new Date().toISOString() }];
        
        try {
          localStorage.setItem(testKey, JSON.stringify(testData));
          console.log('✅ Write to localStorage successful');
          
          const retrieved = JSON.parse(localStorage.getItem(testKey));
          console.log('✅ Read from localStorage successful:', retrieved);
          
          localStorage.removeItem(testKey);
          console.log('✅ Delete from localStorage successful');
          
          const afterDelete = localStorage.getItem(testKey);
          console.log('After delete:', afterDelete);
          
        } catch (error) {
          console.error('❌ localStorage test failed:', error);
        }
        console.log('=== END LOCALSTORAGE TEST ===');
      };
    }); // End DOMContentLoaded
  </script>
</body>
</html> 